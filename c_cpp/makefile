# ==============================================================================
# 変数定義
# ==============================================================================

# コンパイラ (GNU C Compiler)
CC = gcc

# コンパイラオプション
CFLAGS = -Wall -Wextra -g -O2 -MMD

# インクルードディレクトリ
INC_DIR = -I./include

# リンク時に使用するライブラリ
LDFLAGS = -lm

# 実行ファイル名
TARGET = my_program

# cleanターゲットで $(RM) を使う
RM = rm -f

# ソースファイルのディレクトリ
SRC_DIR = src

# ビルド成果物 (オブジェクトファイルなど) を格納するディレクトリ
OBJECTS_DIR = obj
DEPENDS_DIR = .deps

# ソースファイルのリスト
SRCS = $(wildcard $(SRC_DIR)/*.c)

# オブジェクトファイルのリスト
OBJS = $(patsubst $(SRC_DIR)/%.c, $(OBJECTS_DIR)/%.o, $(SRCS))

# 依存関係ファイルのリスト
DEPS = $(patsubst $(OBJECTS_DIR)/%.o, $(DEPENDS_DIR)/%.d, $(OBJS))

# ==============================================================================
# デフォルトターゲット (make とだけ実行したときに呼ばれる)
# ==============================================================================
.PHONY: all # 'all'はファイルではなくアクションであることを示す
all: $(TARGET)

# ==============================================================================
# メインターゲット (実行ファイルの生成)
# ==============================================================================
$(TARGET): $(OBJS)
	@echo "Linking $@"
	$(CC) $(OBJS) -o $@ $(LDFLAGS)

# ==============================================================================
# オブジェクトファイルのコンパイルルール
# ==============================================================================

# オブジェクトファイルディレクトリを作成するルールを追加
$(OBJECTS_DIR):
	@mkdir -p $(OBJECTS_DIR)

# コンパイル前にディレクトリが確実に存在するよう、依存関係を追加
$(OBJECTS_DIR)/%.o: $(SRC_DIR)/%.c | $(OBJECTS_DIR)
	@echo "Compiling $<"
	$(CC) $(CFLAGS) $(INC_DIR) -c $< -o $@

# ==============================================================================
# クリーンアップルール
# ==============================================================================
.PHONY: clean # 'clean'はファイルではなくアクションであることを示す
clean:
	@echo "Cleaning up..."
	$(RM) $(TARGET)
	@rm -rf $(OBJECTS_DIR) $(DEPENDS_DIR)

# ==============================================================================
# 自動生成される依存関係ファイルのインクルード
# ==============================================================================
-include $(DEPS)